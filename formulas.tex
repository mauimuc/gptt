\documentclass[11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[a4paper, margin=3cm]{geometry}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{xfrac}
\usepackage{hyperref}
\usepackage{pgfplots}
\usepackage{color}

\newcommand{\mypath}{.}
\newcommand\worries[1]{\textcolor{red}{#1}}

\title{Correlation Based Surface Wave Tomography}
\author{Stefan Mauerberger}

\begin{document}
\maketitle
\begin{abstract}
    Adopting Gaussian process regression to travel time tomography.
    As a possible future application I am toying around with surface wave tomography.
    The following is just a brief description of the experiment and a summary of formulas I am using.
\end{abstract}

\section{Setting}
\input{def_example}

Use Gaussian process regression together with an underlying correlation structure for surface wave tomography.
For the time being I skip on a description of the modeling method.
Details may be found in my PhD thesis.

The idea in my mind is to use ambient noise records for surface wave tomography.
The average slowness amongst station pairs are obtained from cross correlations.
To avoid the difficulty of dispersion, only a narrow frequency band shall be considered.
Diffraction is neglected to simplify things even further.
Then, the ray path between stations is approximated by a great circle segment.
Travel times amongst stations are given by distances times the average slowness.
\worries{Actually, retrieving travel times that way is going round in circles.
It is the ray path -- i.e.~the distance -- what I am uncertain about!}

This is going to be a synthetic test, only.
The reference model $\tilde c$ is of constant velocity $4\,\sfrac{km}s$ perturbed by two blobs, just large scale anomalies.
At their maximum those blobs are showing a deviation of about $\pm 1\%$ and a characteristic length of $50\,km$.
To proceed with a partly realistic setting the station geometry is borrowed from a subset of the ScanArray (DOI: 10.14470/6T569239).
Due to computational limitations I am just considering \SFWnobs\ stations.
Figure~\ref{fig:path_coverage} depicts the reference velocity model with the path coverage atop.

\begin{figure}
    \centering
    \input{fig_path_coverage.pgf}
    \caption{Path coverage of the Array}
    \label{fig:path_coverage}
\end{figure}

Pseudo observations are generated from the reference velocity model considering all pairs of stations.
Synthetic travel times are obtained by integrating the slowness along the great circle segment.
To simulate measurement noise the set of pseudo observations is corrupted by normal noise of standard deviation $\sigma_\varepsilon = \SFWepsilon$\,.


\section{Line Integral along a Great Circle Segment}
In the oversimplified setting the ray path is given by the shortest distance between two points $u$, $v$ on the surface of a sphere.
\worries{I would use other point variables since u is reserved for group velocites and v is rather a velocity. Just to keep in mind that you once can derive group and phase velocity from your code. use A and B}
The central angle is given by
\begin{align}
    \cos \sphericalangle_u^v &= \frac{u \cdot v}{|u||v|} &
    &\text{or}&
    \sin \sphericalangle_u^v &= \frac{|u \times v|}{|u||v|}
    \; .
\end{align}
To integrate along the ray path, a parametrizing equation of the greate circle passing through $u$ and $v$ is required.
With respect to a Cartesian coordinate frame such a parametrization is of the form
\begin{equation}
    r(t) = u \cos t + w \sin t
\end{equation}
with $t \in [0:2\pi$] and to be determined $w$.
For $w$ we find
\begin{align}
    v &= r(t = \sphericalangle_u^v) &
    &\leadsto &
    w &= \frac{v - u \cos \sphericalangle_u^v}{\sin \sphericalangle_u^v}
    \; .
\end{align}
The segment between $u$ and $v$ is given by $C= \{r(t) \mid t \in [0, \sphericalangle_u^v]\}$.
Travel times are calculated by carrying out the line integral along the great circle segment
\begin{equation}
    T_{u,v}[s]
    = \int_C \frac1{c(r)} \mathrm d r
    = \int_0^{\sphericalangle_u^v} \frac 1{c(r(t))} |\acute r(t)| \mathrm d t
\end{equation}
where $c$ refers to a velocity model.
\worries{c is commonly used for a phase velocity..maybe misleading in that context}
The length of a line element on a great circle is given by
\begin{equation}
    |\acute c(t)| = |w \cos t - u \sin t| = ??? = r_E
    \; .
\end{equation}


\section{Discretization}

As we do not consider diffraction an adoptive discretization is not needed.
To integrate travel times Simpson's rule is used, a fixed samples quadrature scheme.
Therefore, it is necessary to discretize the great circle segment for all station pairs.
All the segments are sampled at almost the same spacing.
The increment is chosen as
\begin{equation}
    \Delta\sphericalangle = \frac 1 \SFWminsamples \min\left\{ \sphericalangle_u^v \mid u,v \in S \right\}
    \approx \SFWdeltaangle \,{}^\circ
\end{equation}
i.e.~half the shortest inter-station distance.

For plotting purposes only, there is a regular $\SFWngrid \times \SFWngrid$ grid covering the domain of interest.

\worries{My implementation comes with quite a number of duplicates.
In total I am considering $\SFWnpts$ grid points.
It were enough to consider station locations just once saving 360 points.}


\section{Correlation Kernel}

Typically, the Gaussian kernel is expressed in terms of the euclidean distance.
As we consider waves traveling along the surface only, the great circle segment is the desired measure of distance.
At the surface, the shortest distance between two points $u$, $v$ is given by
\begin{equation}
    d(u,v) = \sphericalangle_u^v r_E
\end{equation}
with values in $[0, \pi R]$.
The so called great circle distance $d$ shall serve as metric and the correlation kernel of choice reads
\begin{equation}
    K(u,v) = \tau^2 \exp\!\left(-\frac 12 \frac{d(u,v)^2}{\ell^2}\right)
\end{equation}
with characteristic length $\ell$ and variance $\tau^2$.
%That Kernel has an upper and lower bound
%\begin{equation}
%    1 \geq K(x_i,x_j) \geq \tau^2 e^{-\frac12\frac{R^2\pi^2}{\ell^2}} > 0
%\end{equation}
%To proof $K$ is PD consider arbitrary wights $\alpha_i \in \mathbb R$ and locations $x_i \in \mathbb S_{r_E}$ and we have
%\begin{equation}
%    \sum_{ij} \alpha_i K(x_i, x_j) \alpha_j >
%    \varepsilon \sum_{ij} \alpha_i \alpha_j =
%    \varepsilon \sum_i 1 \alpha_i \sum_j 1 \alpha_j =
%    \langle 1,\alpha \rangle^2 > 0
%\end{equation}
%where $\varepsilon$ refers to the lower bound of $K$.

\worries{Matthias suggested to use a Poisson type kernel.
\begin{equation}
    u(x) \propto \iint \frac{R-|x|}{|x-\xi|^3} u(\xi) \, \mathrm d \xi
\end{equation}
Consider white noise at some reference radius $R$ and the covariance is
\begin{equation}
    K(x,y) \propto \iint \frac{R-|x|}{|x-\xi|^3} \frac{R-|y|}{|y-\xi|^3} \, \mathrm d \xi
\end{equation}
the choice of $R$ determines the regularity. }


\begin{figure}
    \input{def_correlation}
    \centering
    \input{fig_correlation.pgf}
    \caption{Correlation amongst a constant velocity model and a travel time observation.
        The kernel's characteristic length is $\ell=\SFWcorrell\,m$ and the path discretization is $\Delta = \SFWcorrds\,{}^\circ$. }
    \label{fig:correlation}
\end{figure}


\section{A\,Priori Model}

Let assume an a\,priori model of constant mean velocity.
Then, four parameters need to be determined before any inversion may be carried out.
That are the error level $\varepsilon$ and the kernels characteristic length $\tau$, variance $\sigma$ and mean velocity $\mu_C$.
\worries{For now I pass on that \dots }

The values I use are
\begin{align}
    \varepsilon &= \SFWepsilon \, s \;,&
    \tau &= \SFWtau \, \sfrac ms \;,&
    \ell &= \SFWell \, m \;,&
    \mu_C &= \SFWmuCpri \, \sfrac ms \;.
\end{align}


\section{Example}

it were interesting to see how the misfit successively evolves \dots
\begin{figure}
    \centering
    \input{fig_example.pgf}
    \caption{Just considering halve the stations due to heavy memory consumption }
    \label{fig:example}
\end{figure}

\begin{figure}
    \centering
    \input{fig_example_var.pgf}
    \caption{posterior standard deviation; artifacts are due to single precision }
    \label{fig:example_var}
\end{figure}

\end{document}

